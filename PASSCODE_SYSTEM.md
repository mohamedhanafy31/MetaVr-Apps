# Passcode System Documentation

This document explains how each type of passcode works in the project, including where they're stored and how they're used.

---

## 1. Admin Passcode (Hardcoded)

### **How It Works:**
- **Value**: `"31720032025"` (hardcoded in the source code)
- **Purpose**: Master passcode to access admin pages
- **Authentication Flow**:
  1. User navigates to `/admin` or `/admin-supervisor` or `/admin-npc`
  2. System shows login form
  3. User enters passcode
  4. System compares input with hardcoded value
  5. If match: Sets `sessionStorage.setItem("adminAuthorized", "true")`
  6. If no match: Shows error message

### **Where It's Saved:**
- **Passcode itself**: Hardcoded in code (not stored)
- **Authorization status**: `sessionStorage` (browser session only)
  - Key: `"adminAuthorized"`
  - Value: `"true"` (string)
  - **Persistence**: Only for current browser tab/session
  - **Cleared when**: Browser tab is closed

### **Files:**
- `vite-project/src/pages/AdminHome.jsx` (line 7, 59, 262)
- `vite-project/src/pages/AdminSupervisor.jsx` (line 5, 10, 55)
- `vite-project/src/pages/AdminNPC.jsx` (line 4, 9, 37)

### **Code Example:**
```javascript
const ADMIN_PASSCODE = "31720032025";
const ADMIN_AUTH_KEY = "adminAuthorized";

// Check authorization
const [authorized, setAuthorized] = useState(() => {
  return sessionStorage.getItem(ADMIN_AUTH_KEY) === "true";
});

// Validate passcode
if (passcode.trim() === ADMIN_PASSCODE) {
  setAuthorized(true);
  sessionStorage.setItem(ADMIN_AUTH_KEY, "true");
}
```

---

## 2. Supervisor Passcodes (Generated)

### **How It Works:**
- **Format**: 8-digit random number (10000000 to 99999999)
- **Purpose**: Access the Supervisor console to manage app passcodes
- **Generation**: 
  - Generated by Admin in AdminHome page
  - Algorithm: `Math.floor(10000000 + Math.random() * 90000000).toString()`
  - Ensures uniqueness (checks existing codes)
- **Authentication Flow**:
  1. User navigates to `/supervisor`
  2. System shows login form
  3. User enters passcode
  4. System loads all supervisor passcodes from localStorage
  5. System checks if entered passcode exists in the list
  6. If found: Grants access and tracks session time
  7. If not found: Shows error message

### **Where It's Saved:**
- **Storage**: `localStorage` (persists across browser sessions)
- **Key**: `"supervisorPasscodes"`
- **Data Structure**:
  ```javascript
  // Old format (legacy, auto-migrated):
  ["12345678", "87654321"]
  
  // New format (current):
  [
    { code: "12345678", usageMinutes: 0 },
    { code: "87654321", usageMinutes: 15 }
  ]
  ```
- **Persistence**: Survives browser restarts, cleared only when:
  - User clears browser data
  - Admin deletes the passcode
  - localStorage is manually cleared

### **Files:**
- `vite-project/src/pages/AdminHome.jsx` (lines 6, 79-90, 114-116, 213-230, 233-238)
- `vite-project/src/pages/Supervisor.jsx` (lines 4, 13, 30-51, 183-209)

### **Code Example:**
```javascript
const SUPERVISOR_PASSCODES_KEY = "supervisorPasscodes";

// Load passcodes
const [supervisorPasscodes, setSupervisorPasscodes] = useState(() => {
  const saved = localStorage.getItem(SUPERVISOR_PASSCODES_KEY);
  return saved ? JSON.parse(saved) : [];
});

// Generate new passcode
const generateRandomPasscode = () => {
  return Math.floor(10000000 + Math.random() * 90000000).toString();
};

// Validate passcode
const allowed = JSON.parse(localStorage.getItem(SUPERVISOR_PASSCODES_KEY) || "[]");
const matchedCode = allowed.find(item => {
  const code = typeof item === 'string' ? item : item.code;
  return code === trimmedInput;
});
```

### **Usage Tracking:**
- Tracks time spent in Supervisor console
- Updates `usageMinutes` every minute
- Persisted in localStorage

---

## 3. App Passcodes (Generated per App)

### **How It Works:**
- **Format**: 8-digit random number (10000000 to 99999999)
- **Purpose**: Access individual apps from the Home page
- **Generation**:
  - Generated by Supervisor in Supervisor page
  - One passcode per app (multiple passcodes can exist per app)
  - Algorithm: `Math.floor(10000000 + Math.random() * 90000000).toString()`
  - Auto-generates unique name: `"{app-name}-user{number}"`
- **Authentication Flow**:
  1. User clicks on an app card in Home page
  2. System shows passcode modal
  3. User enters 8-digit passcode
  4. System loads app passcodes from localStorage for that specific app
  5. System checks if passcode exists and has permission
  6. If valid and has permission: Grants access, starts session tracking
  7. If valid but no permission: Shows "Access Denied" modal
  8. If invalid: Shows error message

### **Where It's Saved:**
- **Storage**: `localStorage` (persists across browser sessions)
- **Key**: `"appPasscodes"`
- **Data Structure**:
  ```javascript
  {
    "1": [  // App ID
      {
        code: "12345678",
        name: "3d-racing-game-user0",
        permission: true,      // Can access the app
        paid: false,           // Payment status
        usageMinutes: 45       // Total usage time
      },
      {
        code: "87654321",
        name: "3d-racing-game-user1",
        permission: true,
        paid: true,
        usageMinutes: 120
      }
    ],
    "3": [  // Another app ID
      {
        code: "11223344",
        name: "ai-npc-demo-user0",
        permission: false,     // Access denied
        paid: false,
        usageMinutes: 0
      }
    ]
  }
  ```

### **Files:**
- `vite-project/src/pages/Supervisor.jsx` (lines 6, 18-27, 228-274)
- `vite-project/src/pages/Home.jsx` (lines 5, 64, 92-130, 291-355)
- `vite-project/src/pages/AdminHome.jsx` (lines 5, 74-77, 110-112, 161-207)

### **Code Example:**
```javascript
const APP_PASSCODES_KEY = "appPasscodes";

// Load app passcodes
const [appPasscodes, setAppPasscodes] = useState(() => {
  const saved = localStorage.getItem(APP_PASSCODES_KEY);
  return saved ? JSON.parse(saved) : {};
});

// Validate passcode for specific app
const appPasscodes = JSON.parse(localStorage.getItem(APP_PASSCODES_KEY) || "{}");
const appCodes = appPasscodes[appId] || [];
const matchedCode = appCodes.find(item => {
  const code = typeof item === 'string' ? item : item.code;
  return code === trimmedInput;
});

// Check permission
if (matchedCode && matchedCode.permission) {
  // Grant access
} else if (matchedCode && !matchedCode.permission) {
  // Show access denied
}
```

### **Features:**
- **Permission Control**: Admin/Supervisor can disable access (`permission: false`)
- **Payment Tracking**: Track if user has paid (`paid: true/false`)
- **Usage Tracking**: Tracks time spent in each app (updates every 30 seconds)
- **Session Management**: Tracks active sessions for Unity apps that reload

### **Usage Tracking:**
- Updates every 30 seconds while app is active
- Updates on tab switch/minimize
- Updates on page unload
- Persisted in localStorage

---

## 4. NPC Codes (Legacy/Alternative)

### **How It Works:**
- **Format**: Custom (any string)
- **Purpose**: Alternative access codes specifically for NPC app
- **Generation**: Manually entered by Admin
- **Authentication Flow**:
  1. User accesses NPC app
  2. System checks NPC codes from localStorage
  3. If code matches: Grants access
  4. If not: Denies access

### **Where It's Saved:**
- **Storage**: `localStorage` (persists across browser sessions)
- **Key**: `"npcCodes"`
- **Data Structure**:
  ```javascript
  [
    { code: "NPC123", usageMinutes: 0 },
    { code: "NPC456", usageMinutes: 30 }
  ]
  ```

### **Files:**
- `vite-project/src/pages/AdminNPC.jsx` (lines 13-21, 23-27, 29-31)
- `vite-project/src/pages/Admin.jsx` (lines 5, 14, 22)

### **Code Example:**
```javascript
const [codes, setCodes] = useState(() => {
  const saved = localStorage.getItem("npcCodes");
  return saved ? JSON.parse(saved) : [];
});

// Save codes
useEffect(() => {
  localStorage.setItem("npcCodes", JSON.stringify(codes));
}, [codes]);
```

---

## Storage Summary

| Passcode Type | Storage Location | Key | Persistence | Data Format |
|--------------|------------------|-----|-------------|-------------|
| **Admin Passcode** | Hardcoded in code | N/A | N/A | String constant |
| **Admin Auth Status** | `sessionStorage` | `"adminAuthorized"` | Session only | `"true"` |
| **Supervisor Passcodes** | `localStorage` | `"supervisorPasscodes"` | Permanent | Array of objects |
| **App Passcodes** | `localStorage` | `"appPasscodes"` | Permanent | Object with app IDs as keys |
| **NPC Codes** | `localStorage` | `"npcCodes"` | Permanent | Array of objects |

---

## localStorage vs sessionStorage

### **localStorage:**
- **Persistence**: Survives browser restarts
- **Scope**: Shared across all tabs/windows of same origin
- **Cleared**: Only when user manually clears browser data
- **Used for**: Passcodes, projects, usage data

### **sessionStorage:**
- **Persistence**: Only for current browser tab
- **Scope**: Tab-specific (not shared across tabs)
- **Cleared**: When tab is closed
- **Used for**: Admin authorization status, active app sessions

---

## Data Flow Example

### **Creating App Passcode:**
1. Admin logs in with admin passcode → `sessionStorage["adminAuthorized"] = "true"`
2. Admin generates supervisor passcode → Saved to `localStorage["supervisorPasscodes"]`
3. Supervisor logs in with supervisor passcode → Validates against `localStorage["supervisorPasscodes"]`
4. Supervisor generates app passcode for "AI NPC Demo" → Saved to `localStorage["appPasscodes"]["3"]`
5. User clicks "AI NPC Demo" → System loads `localStorage["appPasscodes"]["3"]`
6. User enters passcode → System validates and checks `permission` field
7. If valid: Starts session tracking → Updates `usageMinutes` every 30 seconds

---

## Security Notes

⚠️ **Important Security Considerations:**

1. **Admin Passcode**: Hardcoded in source code - visible to anyone with access to the codebase
2. **All Passcodes**: Stored in browser localStorage - accessible via browser DevTools
3. **No Encryption**: All passcodes stored in plain text
4. **Client-Side Only**: No server-side validation (all logic runs in browser)
5. **Recommendation**: For production, implement server-side authentication and encryption

---

## Migration Notes

The system includes automatic migration for:
- **Supervisor Passcodes**: Migrates from string array to object array with usage tracking
- **App Passcodes**: Migrates from string array to object array with full metadata

Migration happens automatically on first load if old format is detected.

