# Multi-stage Dockerfile for Frontend Production Build
FROM node:20-alpine AS builder

WORKDIR /app

# Install tools for downloading and extracting
# Using unrar-nonfree for RAR v5 support (7z doesn't fully support RAR v5)
# Also install file command for file type detection and p7zip as fallback
RUN apk add --no-cache wget curl python3 py3-pip file p7zip && \
    apk add --no-cache --repository=http://dl-cdn.alpinelinux.org/alpine/edge/community unrar || \
    (echo "unrar not available, will use Python rarfile as fallback" && pip3 install --no-cache-dir --break-system-packages rarfile)

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm ci

# Copy application files
COPY . .

# Download and extract Unity NPC files from Google Drive
# File ID: 1zQ5DCoamu-hAzzB3-p45-QNKxx_EdDks
# Using gdown for reliable large file downloads from Google Drive
# Using unrar for RAR v5 support (7z doesn't fully support RAR v5)
# Extract to public/unity/npc/ directory
RUN pip3 install --no-cache-dir --break-system-packages gdown && \
    mkdir -p public/unity/npc && \
    cd public/unity && \
    echo "Downloading Unity NPC files from Google Drive..." && \
    gdown 1zQ5DCoamu-hAzzB3-p45-QNKxx_EdDks -O npc.rar && \
    echo "Verifying downloaded file..." && \
    ls -lh npc.rar && \
    FILE_TYPE=$(file npc.rar 2>/dev/null || echo "unknown") && \
    echo "File type: $FILE_TYPE" && \
    echo "==========================================" && \
    echo "ðŸ” DEBUG: Starting RAR extraction process" && \
    echo "==========================================" && \
    echo "RAR file location: /app/public/unity/npc.rar" && \
    echo "RAR file size: $(ls -lh /app/public/unity/npc.rar | awk '{print $5}')" && \
    echo "Target directory: /app/public/unity/npc/" && \
    echo "" && \
    echo "Extracting npc.rar to temporary directory..." && \
    mkdir -p /tmp/extract_temp && \
    cd /tmp/extract_temp && \
    echo "DEBUG: Extracting from $(pwd)" && \
    if command -v unrar >/dev/null 2>&1; then \
      echo "Using unrar for extraction..." && \
      unrar x /app/public/unity/npc.rar -y 2>&1 | tee /tmp/extract.log || (echo "unrar failed, trying Python rarfile..." && python3 -c "import rarfile; rf = rarfile.RarFile('/app/public/unity/npc.rar'); rf.extractall('.'); print('Extraction complete')" 2>&1 | tee -a /tmp/extract.log || true); \
    elif python3 -c "import rarfile" 2>/dev/null; then \
      echo "Using Python rarfile for extraction..." && \
      python3 << 'PYEOF' 2>&1 | tee /tmp/extract.log || true
import rarfile
import sys
import os

try:
    rf = rarfile.RarFile('/app/public/unity/npc.rar')
    print(f"RAR file opened successfully. Number of files: {len(rf.namelist())}")
    print("Extracting all files...")
    rf.extractall('.')
    print("Extraction complete!")
    print(f"Extracted files: {len([f for f in os.listdir('.') if os.path.isfile(f)])}")
    print(f"Extracted directories: {len([d for d in os.listdir('.') if os.path.isdir(d)])}")
except Exception as e:
    print(f"ERROR during extraction: {e}", file=sys.stderr)
    import traceback
    traceback.print_exc()
    sys.exit(1)
PYEOF
    else \
      echo "Using 7z as fallback (may not fully support RAR v5)..." && \
      7z x /app/public/unity/npc.rar -y 2>&1 | tee /tmp/extract.log || true; \
    fi && \
    echo "" && \
    echo "Checking extraction results..." && \
    if [ -f "/tmp/extract.log" ]; then \
      echo "Extraction log (last 50 lines):"; \
      tail -50 /tmp/extract.log; \
    fi && \
    echo "" && \
    echo "==========================================" && \
    echo "ðŸ” DEBUG: Checking extraction results" && \
    echo "==========================================" && \
    echo "Current directory: $(pwd)" && \
    echo "All files and directories extracted:" && \
    find . -type f -o -type d | sort | head -50 && \
    echo "" && \
    echo "File count: $(find . -type f | wc -l)" && \
    echo "Directory count: $(find . -type d | wc -l)" && \
    echo "" && \
    echo "Looking for key files/folders..." && \
    echo "Has npc folder: $([ -d "npc" ] && echo "YES" || echo "NO")" && \
    echo "Has index.html: $([ -f "index.html" ] && echo "YES" || echo "NO")" && \
    echo "Has npc/index.html: $([ -f "npc/index.html" ] && echo "YES" || echo "NO")" && \
    echo "Has Build folder: $([ -d "Build" ] && echo "YES" || echo "NO")" && \
    echo "Has npc/Build folder: $([ -d "npc/Build" ] && echo "YES" || echo "NO")" && \
    echo "" && \
    echo "All extracted files and directories:" && \
    find . -type f -o -type d | sort && \
    echo "" && \
    if [ -d "npc" ]; then \
      echo "âœ… Found npc folder in extraction"; \
      echo "Contents of npc folder:"; \
      ls -lah npc/; \
      echo ""; \
      echo "All files in npc folder:"; \
      find npc -type f; \
      echo ""; \
      echo "All directories in npc folder:"; \
      find npc -type d; \
      echo ""; \
      echo "Moving npc folder contents to target location..."; \
      cp -r npc/* /app/public/unity/npc/ 2>&1 || echo "Copy failed, trying alternative..."; \
      cp -r npc/.??* /app/public/unity/npc/ 2>&1 || true; \
    elif [ -f "index.html" ] || [ -d "Build" ]; then \
      echo "âœ… Files found at root of extraction"; \
      echo "Root files:"; \
      ls -lah .; \
      echo "Moving files to target location..."; \
      cp -r * /app/public/unity/npc/ 2>&1 || echo "Copy failed"; \
      cp -r .??* /app/public/unity/npc/ 2>&1 || true; \
    else \
      echo "âš ï¸ No expected structure found, listing all extracted items:"; \
      find . -type f | head -30; \
      find . -type d | head -20; \
      echo "Attempting to copy everything to target..."; \
      cp -r * /app/public/unity/npc/ 2>&1 || echo "Copy failed"; \
    fi && \
    cd /app/public/unity && \
    echo "" && \
    echo "==========================================" && \
    echo "ðŸ” DEBUG: Verifying files in target directory" && \
    echo "==========================================" && \
    echo "Target directory: $(pwd)/npc" && \
    echo "Files in npc directory:" && \
    ls -lah npc/ && \
    echo "" && \
    echo "File count in npc: $(find npc -type f | wc -l)" && \
    echo "Directory count in npc: $(find npc -type d | wc -l)" && \
    echo "" && \
    echo "Looking for index.html: $([ -f "npc/index.html" ] && echo "âœ… FOUND" || echo "âŒ NOT FOUND")" && \
    echo "Looking for Build directory: $([ -d "npc/Build" ] && echo "âœ… FOUND" || echo "âŒ NOT FOUND")" && \
    if [ -d "npc/Build" ]; then \
      echo "Build directory contents:"; \
      ls -lah npc/Build/ | head -20; \
    fi && \
    cd /app && \
    echo "Now in /app, verifying public/unity/npc structure..." && \
    echo "" && \
    echo "==========================================" && \
    echo "ðŸ” CRITICAL: Verifying required files exist" && \
    echo "==========================================" && \
    if [ ! -f "public/unity/npc/index.html" ] || [ ! -d "public/unity/npc/Build" ]; then \
      echo ""; \
      echo "=========================================="; \
      echo "âŒ BUILD FAILED: Required Unity NPC files are missing!"; \
      echo "=========================================="; \
      if [ ! -f "public/unity/npc/index.html" ]; then \
        echo "âŒ ERROR: index.html is missing!"; \
      fi; \
      if [ ! -d "public/unity/npc/Build" ]; then \
        echo "âŒ ERROR: Build directory is missing!"; \
      fi; \
      echo ""; \
      echo "The RAR file appears to be corrupted or incomplete."; \
      echo "Expected files:"; \
      echo "  - public/unity/npc/index.html"; \
      echo "  - public/unity/npc/Build/ (directory with Unity files)"; \
      echo ""; \
      echo "Found files:"; \
      find public/unity/npc -type f | head -20; \
      echo ""; \
      echo "Please check the RAR file on Google Drive and ensure it contains:"; \
      echo "  - index.html"; \
      echo "  - Build/ directory with Unity WebGL files (yes.loader.js, yes.data.gz, etc.)"; \
      echo "  - All other required Unity assets"; \
      echo ""; \
      echo "The RAR file may need to be re-uploaded."; \
      exit 1; \
    fi && \
    echo "âœ… index.html found!"; \
    echo "âœ… Build directory found!"; \
    echo "Checking for Unity files in Build directory..." && \
    if [ -f "public/unity/npc/Build/yes.loader.js" ] || [ -f "public/unity/npc/Build/npc.loader.js" ]; then \
      echo "âœ… Unity loader file found!"; \
    else \
      echo "âš ï¸ WARNING: Unity loader file not found (expected yes.loader.js or npc.loader.js)"; \
    fi && \
    echo "âœ… All required files found!" && \
    rm -f public/unity/npc.rar && \
    echo "==========================================" && \
    echo "ðŸ“ VERIFYING FINAL STRUCTURE IN public/unity/npc/" && \
    echo "==========================================" && \
    if [ -d "public/unity/npc" ]; then \
      echo "âœ… Directory exists: public/unity/npc/" && \
      echo "" && \
      echo "ðŸ“‹ Full directory listing:" && \
      ls -lah public/unity/npc/ && \
      echo "" && \
      echo "ðŸ“Š File count:" && \
      find public/unity/npc -type f | wc -l && \
      echo "ðŸ“ Directory count:" && \
      find public/unity/npc -type d | wc -l && \
      echo "" && \
      echo "ðŸ” Checking for key files:" && \
      if [ -f "public/unity/npc/index.html" ]; then \
        echo "âœ… index.html found in public/unity/npc/"; \
        ls -lh public/unity/npc/index.html; \
      else \
        echo "âš ï¸ index.html NOT found in public/unity/npc/"; \
        echo "Looking for HTML files:"; \
        find public/unity/npc -name "*.html" -type f || echo "No HTML files found"; \
      fi; \
      echo "" && \
      if [ -d "public/unity/npc/Build" ]; then \
        echo "âœ… Build directory found in public/unity/npc/"; \
        echo "ðŸ“‹ Build directory contents:" && \
        ls -lah public/unity/npc/Build/; \
        echo "" && \
        echo "ðŸ” Key Unity files in Build:" && \
        ls -lh public/unity/npc/Build/*.js public/unity/npc/Build/*.wasm public/unity/npc/Build/*.data 2>/dev/null || echo "Some Unity files may be missing"; \
      else \
        echo "âš ï¸ Build directory NOT found in public/unity/npc/"; \
        echo "Looking for Build directories:"; \
        find public/unity/npc -type d -name "Build" || echo "No Build directory found"; \
      fi; \
      echo "" && \
      echo "ðŸ“‚ Complete directory tree (first 3 levels):" && \
      find public/unity/npc -maxdepth 3 -print | head -30; \
    else \
      echo "âŒ public/unity/npc/ directory does not exist!"; \
      echo "Checking what exists in public/unity/:" && \
      ls -lah public/unity/ 2>/dev/null || echo "public/unity/ does not exist"; \
    fi && \
    echo "==========================================" && \
    pip3 uninstall -y --break-system-packages gdown rarfile 2>/dev/null || true && \
    apk del python3 py3-pip p7zip unrar 2>/dev/null || true && \
    echo "Unity NPC files extraction completed to public/unity/npc/"

# Build the application
RUN npm run build && \
    echo "==========================================" && \
    echo "ðŸ“ VERIFYING UNITY FILES IN dist DIRECTORY" && \
    echo "==========================================" && \
    if [ -d "dist/unity/npc" ]; then \
      echo "âœ… Directory exists: dist/unity/npc/" && \
      echo "" && \
      echo "ðŸ“‹ Full directory listing:" && \
      ls -lah dist/unity/npc/ && \
      echo "" && \
      echo "ðŸ“Š File count:" && \
      find dist/unity/npc -type f | wc -l && \
      echo "ðŸ“ Directory count:" && \
      find dist/unity/npc -type d | wc -l && \
      echo "" && \
      echo "ðŸ” Checking for key files:" && \
      if [ -f "dist/unity/npc/index.html" ]; then \
        echo "âœ… index.html found in dist/unity/npc/"; \
        ls -lh dist/unity/npc/index.html; \
      else \
        echo "âš ï¸ index.html NOT found in dist/unity/npc/"; \
        echo "Looking for HTML files:"; \
        find dist/unity/npc -name "*.html" -type f || echo "No HTML files found"; \
      fi; \
      echo "" && \
      if [ -d "dist/unity/npc/Build" ]; then \
        echo "âœ… Build directory found in dist/unity/npc/"; \
        echo "ðŸ“‹ Build directory contents:" && \
        ls -lah dist/unity/npc/Build/; \
        echo "" && \
        echo "ðŸ” Key Unity files in Build:" && \
        ls -lh dist/unity/npc/Build/*.js dist/unity/npc/Build/*.wasm dist/unity/npc/Build/*.data 2>/dev/null || echo "Some Unity files may be missing"; \
      else \
        echo "âš ï¸ Build directory NOT found in dist/unity/npc/"; \
        echo "Looking for Build directories:"; \
        find dist/unity/npc -type d -name "Build" || echo "No Build directory found"; \
      fi; \
      echo "" && \
      echo "ðŸ“‚ Complete directory tree (first 3 levels):" && \
      find dist/unity/npc -maxdepth 3 -print | head -30; \
    else \
      echo "âŒ dist/unity/npc/ directory not found!" && \
      echo "Checking dist structure:" && \
      echo "Top-level dist contents:" && \
      ls -lah dist/ | head -20 && \
      echo "" && \
      echo "Searching for unity or npc:" && \
      find dist -name "unity" -o -name "npc" 2>/dev/null | head -20; \
    fi && \
    echo "=========================================="

# Production stage
FROM nginx:alpine

# Copy built files from builder
COPY --from=builder /app/dist /usr/share/nginx/html

# Copy nginx configuration
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Expose port
EXPOSE 80

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:80 || exit 1

# Start nginx
CMD ["nginx", "-g", "daemon off;"]

