# CDN configuration (envsubst will substitute ${CDN_IP} at container startup)
# If CDN_IP is set, use CDN URL (faster), otherwise use GCS directly
# envsubst replaces ${CDN_IP} with actual value or empty string

server {
    listen ${PORT:-8080};
    server_name _;
    
    root /usr/share/nginx/html;
    index index.html;

    # Include MIME types
    include /etc/nginx/mime.types;

    # Disable gzip compression (Unity files are pre-compressed)
    gzip off;

    # ========== Unity WebGL Files Proxy to GCS/CDN ==========
    # Use proxy_pass instead of redirect for better performance
    # This eliminates redirect latency and allows browser caching
    # If CDN_IP env var is set, use CDN URL (faster), otherwise use GCS directly
    location /unity/npc/ {
        # Use CDN if CDN_IP is set, otherwise use GCS
        # envsubst replaces ${CDN_IP} at container startup
        # If CDN_IP is empty, envsubst will leave it empty, and we use GCS
        # If CDN_IP is set (e.g., "34.102.136.180"), we use CDN URL
        # We use a workaround: check if the URL contains "http://" (CDN) or "https://" (GCS)
        set $cdn_url "https://storage.googleapis.com/metavr-assets/unity/npc/";
        # If CDN_IP is set, envsubst will replace ${CDN_IP} with the IP
        # We check if CDN_IP contains a dot (IP address pattern)
        if ("${CDN_IP}" ~ ".") {
            set $cdn_url "http://${CDN_IP}/unity/npc/";
        }
        proxy_pass $cdn_url;
        
        # Preserve original request headers
        # Host header: use CDN IP if using CDN, otherwise use storage.googleapis.com
        set $proxy_host "storage.googleapis.com";
        if ("${CDN_IP}" ~ ".") {
            set $proxy_host "${CDN_IP}";
        }
        proxy_set_header Host $proxy_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cache settings for proxy
        proxy_cache_valid 200 1y;
        proxy_cache_valid 404 1m;
        
        # Pass through response headers from GCS
        proxy_pass_header Content-Type;
        proxy_pass_header Content-Encoding;
        proxy_pass_header Cache-Control;
        proxy_pass_header Cross-Origin-Embedder-Policy;
        proxy_pass_header Cross-Origin-Opener-Policy;
        proxy_pass_header Cross-Origin-Resource-Policy;
        
        # Timeout settings for large files
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # Buffer settings for large files
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }

    # Unity WebGL files - handle gzipped files correctly (for local fallback if needed)
    location ~* \.wasm\.gz$ {
        add_header Content-Encoding gzip always;
        add_header Content-Type application/wasm always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        # Cache for 1 year (immutable files)
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    location ~* \.data\.gz$ {
        add_header Content-Encoding gzip always;
        add_header Content-Type application/octet-stream always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        # Cache for 1 year (immutable files)
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    location ~* \.js\.gz$ {
        add_header Content-Encoding gzip always;
        add_header Content-Type application/javascript always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        # Cache for 1 year (immutable files)
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    # Brotli support (if Unity files are available as .br)
    location ~* \.wasm\.br$ {
        add_header Content-Encoding br always;
        add_header Content-Type application/wasm always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    location ~* \.data\.br$ {
        add_header Content-Encoding br always;
        add_header Content-Type application/octet-stream always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    location ~* \.js\.br$ {
        add_header Content-Encoding br always;
        add_header Content-Type application/javascript always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    # SPA routing - serve index.html for all routes
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Cache static assets (JS, CSS, images, fonts, WASM, data files)
    # Long cache for immutable assets to improve performance
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|wasm|data)$ {
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }
}
