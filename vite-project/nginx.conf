# Map CDN IP to CDN URL (if CDN_IP is set, use CDN, otherwise use GCS)
# nginx:alpine will substitute ${CDN_IP} at runtime using envsubst
# If CDN_IP is empty or not set, use GCS directly
# If CDN_IP is set (IP address), use CDN URL for faster edge caching
map "${CDN_IP}" $cdn_base_url {
    default "https://storage.googleapis.com/metavr-assets";
    "~^[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}$" "http://${CDN_IP}";
    "" "https://storage.googleapis.com/metavr-assets";
}

# Map CDN IP to Host header
map "${CDN_IP}" $proxy_host {
    default "storage.googleapis.com";
    "~^[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}$" "${CDN_IP}";
    "" "storage.googleapis.com";
}

server {
    listen ${PORT:-8080};
    server_name _;
    
    root /usr/share/nginx/html;
    index index.html;

    # Include MIME types
    include /etc/nginx/mime.types;

    # Disable gzip compression (Unity files are pre-compressed)
    gzip off;

    # ========== Unity WebGL Files Proxy to GCS/CDN ==========
    # Use proxy_pass instead of redirect for better performance
    # This eliminates redirect latency and allows browser caching
    # If CDN_IP env var is set, use CDN URL (faster), otherwise use GCS directly
    location /unity/npc/ {
        # Use CDN if available (from CDN_IP env var), otherwise fallback to GCS
        # $cdn_base_url is set by map directive above based on CDN_IP env var
        proxy_pass $cdn_base_url/unity/npc/;
        
        # Preserve original request headers
        # Host header is set by map directive above based on CDN_IP
        proxy_set_header Host $proxy_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cache settings for proxy
        proxy_cache_valid 200 1y;
        proxy_cache_valid 404 1m;
        
        # Pass through response headers from GCS
        proxy_pass_header Content-Type;
        proxy_pass_header Content-Encoding;
        proxy_pass_header Cache-Control;
        proxy_pass_header Cross-Origin-Embedder-Policy;
        proxy_pass_header Cross-Origin-Opener-Policy;
        proxy_pass_header Cross-Origin-Resource-Policy;
        
        # Timeout settings for large files
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # Buffer settings for large files
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }

    # Unity WebGL files - handle gzipped files correctly (for local fallback if needed)
    location ~* \.wasm\.gz$ {
        add_header Content-Encoding gzip always;
        add_header Content-Type application/wasm always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        # Cache for 1 year (immutable files)
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    location ~* \.data\.gz$ {
        add_header Content-Encoding gzip always;
        add_header Content-Type application/octet-stream always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        # Cache for 1 year (immutable files)
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    location ~* \.js\.gz$ {
        add_header Content-Encoding gzip always;
        add_header Content-Type application/javascript always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        # Cache for 1 year (immutable files)
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    # Brotli support (if Unity files are available as .br)
    location ~* \.wasm\.br$ {
        add_header Content-Encoding br always;
        add_header Content-Type application/wasm always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    location ~* \.data\.br$ {
        add_header Content-Encoding br always;
        add_header Content-Type application/octet-stream always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    location ~* \.js\.br$ {
        add_header Content-Encoding br always;
        add_header Content-Type application/javascript always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    # SPA routing - serve index.html for all routes
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Cache static assets (JS, CSS, images, fonts, WASM, data files)
    # Long cache for immutable assets to improve performance
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|wasm|data)$ {
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }
}
