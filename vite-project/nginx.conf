# CDN configuration (envsubst will substitute ${CDN_IP} at container startup)
# If CDN_IP is set, use CDN URL (faster), otherwise use GCS directly
# envsubst replaces ${CDN_IP} with actual value or empty string

# Proxy cache configuration for Unity files
proxy_cache_path /tmp/nginx_cache levels=1:2 keys_zone=unity_cache:10m max_size=1g inactive=1h use_temp_path=off;

server {
    listen ${PORT};
    server_name _;
    
    root /usr/share/nginx/html;
    index index.html;

    # Include MIME types
    include /etc/nginx/mime.types;

    # Keep-Alive optimizations (HTTP/2 handled by Cloud Run load balancer)
    keepalive_timeout 65;
    keepalive_requests 100;

    # Disable gzip compression (Unity files are pre-compressed)
    gzip off;

    # ========== Unity WebGL Files Proxy to GCS/CDN ==========
    # Alternative solution: Proxy with caching (if Direct GCS URLs not used)
    # Use proxy_pass instead of redirect for better performance
    # This eliminates redirect latency and allows browser caching
    # If CDN_IP env var is set, use CDN URL (faster), otherwise use GCS directly
    location /unity/npc/ {
        # Enable proxy caching for Unity files
        proxy_cache unity_cache;
        proxy_cache_valid 200 1h;
        proxy_cache_valid 404 1m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;
        proxy_cache_lock on;
        
        # Use CDN if CDN_IP is set, otherwise use GCS
        # Entrypoint script will replace ${CDN_PROXY_URL} and ${CDN_PROXY_HOST} at startup
        proxy_pass ${CDN_PROXY_URL};
        
        # Preserve original request headers
        proxy_set_header Host ${CDN_PROXY_HOST};
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
        proxy_http_version 1.1;
        
        # Pass through response headers from GCS
        proxy_pass_header Content-Type;
        proxy_pass_header Content-Encoding;
        proxy_pass_header Cache-Control;
        proxy_pass_header Cross-Origin-Embedder-Policy;
        proxy_pass_header Cross-Origin-Opener-Policy;
        proxy_pass_header Cross-Origin-Resource-Policy;
        
        # Timeout settings for large files
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # Buffer settings for large files (optimized)
        proxy_buffering on;
        proxy_buffer_size 8k;
        proxy_buffers 16 8k;
        proxy_busy_buffers_size 16k;
        proxy_max_temp_file_size 0;
    }

    # Unity WebGL files - handle gzipped files correctly (for local fallback if needed)
    location ~* \.wasm\.gz$ {
        add_header Content-Encoding gzip always;
        add_header Content-Type application/wasm always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        # Cache for 1 year (immutable files)
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    location ~* \.data\.gz$ {
        add_header Content-Encoding gzip always;
        add_header Content-Type application/octet-stream always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        # Cache for 1 year (immutable files)
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    location ~* \.js\.gz$ {
        add_header Content-Encoding gzip always;
        add_header Content-Type application/javascript always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        # Cache for 1 year (immutable files)
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    # Brotli support (if Unity files are available as .br)
    location ~* \.wasm\.br$ {
        add_header Content-Encoding br always;
        add_header Content-Type application/wasm always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    location ~* \.data\.br$ {
        add_header Content-Encoding br always;
        add_header Content-Type application/octet-stream always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    location ~* \.js\.br$ {
        add_header Content-Encoding br always;
        add_header Content-Type application/javascript always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    # SPA routing - serve index.html for all routes
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Cache static assets (JS, CSS, images, fonts, WASM, data files)
    # Long cache for immutable assets to improve performance
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|wasm|data)$ {
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }
}
