server {
    listen 8080;
    server_name _;
    
    root /usr/share/nginx/html;
    index index.html;

    # Include MIME types
    include /etc/nginx/mime.types;

    # Disable gzip compression (Unity files are pre-compressed)
    gzip off;

    # ========== Unity WebGL Files Proxy to GCS/CDN ==========
    # Use proxy_pass instead of redirect for better performance
    # This eliminates redirect latency and allows browser caching
    location /unity/npc/ {
        # Proxy directly to GCS (or CDN if available)
        # Using proxy_pass is faster than redirect - no extra round trip
        proxy_pass https://storage.googleapis.com/metavr-assets/unity/npc/;
        
        # Preserve original request headers
        proxy_set_header Host storage.googleapis.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cache settings for proxy
        proxy_cache_valid 200 1y;
        proxy_cache_valid 404 1m;
        
        # Pass through response headers from GCS
        proxy_pass_header Content-Type;
        proxy_pass_header Content-Encoding;
        proxy_pass_header Cache-Control;
        proxy_pass_header Cross-Origin-Embedder-Policy;
        proxy_pass_header Cross-Origin-Opener-Policy;
        proxy_pass_header Cross-Origin-Resource-Policy;
        
        # Timeout settings for large files
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # Buffer settings for large files
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }

    # Unity WebGL files - handle gzipped files correctly (for local fallback if needed)
    location ~* \.wasm\.gz$ {
        add_header Content-Encoding gzip always;
        add_header Content-Type application/wasm always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        # Cache for 1 year (immutable files)
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    location ~* \.data\.gz$ {
        add_header Content-Encoding gzip always;
        add_header Content-Type application/octet-stream always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        # Cache for 1 year (immutable files)
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    location ~* \.js\.gz$ {
        add_header Content-Encoding gzip always;
        add_header Content-Type application/javascript always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        # Cache for 1 year (immutable files)
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    # Brotli support (if Unity files are available as .br)
    location ~* \.wasm\.br$ {
        add_header Content-Encoding br always;
        add_header Content-Type application/wasm always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    location ~* \.data\.br$ {
        add_header Content-Encoding br always;
        add_header Content-Type application/octet-stream always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    location ~* \.js\.br$ {
        add_header Content-Encoding br always;
        add_header Content-Type application/javascript always;
        add_header Cross-Origin-Embedder-Policy "require-corp" always;
        add_header Cross-Origin-Opener-Policy "same-origin" always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }

    # SPA routing - serve index.html for all routes
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Cache static assets (JS, CSS, images, fonts, WASM, data files)
    # Long cache for immutable assets to improve performance
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|wasm|data)$ {
        expires 1y;
        add_header Cache-Control "public, immutable" always;
    }
}
