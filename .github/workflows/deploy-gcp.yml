name: Deploy to Google Cloud Run

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  PROJECT_ID: meta-478212
  SERVICE_NAME: metavr-frontend
  REGION: us-central1
  # GCS bucket name - uses a fixed name for consistency, or set via secret
  # This bucket is used for Unity WebGL files (redirected from Cloud Run)
  GCS_BUCKET_NAME: ${{ secrets.UNITY_GCS_BUCKET_NAME || 'metavr-assets' }}
  # Google Drive file ID for Unity NPC files
  UNITY_DRIVE_FILE_ID: 1zQ5DCoamu-hAzzB3-p45-QNKxx_EdDks
  # Enable Cloud CDN (always enabled - requires Load Balancer, costs ~$18/month)
  # Cloud CDN will be automatically set up for optimal performance
  ENABLE_CDN: 'true'

jobs:
  setup-gcs-and-upload:
    name: Setup GCS Bucket and Upload Unity Files
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          export_default_credentials: true

      - name: Enable required APIs
        continue-on-error: true
        run: |
          gcloud services enable storage.googleapis.com --quiet
          gcloud services enable storage-component.googleapis.com --quiet
          # Enable Compute API for Cloud CDN (required for Load Balancer)
          echo "ðŸŒ Enabling Compute API for Cloud CDN..."
          gcloud services enable compute.googleapis.com --quiet
          gcloud services enable cloudresourcemanager.googleapis.com --quiet

      - name: Install extraction tools
        run: |
          sudo apt-get update
          sudo apt-get install -y unrar p7zip-full python3-pip
          pip3 install --break-system-packages gdown rarfile

      - name: Download Unity files from Google Drive
        run: |
          echo "ðŸ“¥ Downloading Unity NPC files from Google Drive..."
          mkdir -p unity-temp
          cd unity-temp
          
          FILE_ID="${{ env.UNITY_DRIVE_FILE_ID }}"
          echo "File ID: $FILE_ID"
          
          # Use gdown to download (handles large files automatically)
          gdown "https://drive.google.com/uc?id=$FILE_ID" -O npc.rar || {
            echo "âŒ Failed to download from Google Drive"
            exit 1
          }
          
          echo "âœ… Download complete"
          ls -lh npc.rar

      - name: Extract Unity files
        run: |
          cd unity-temp
          echo "ðŸ“¦ Extracting Unity files..."
          
          # Try unrar first, fallback to Python rarfile
          if command -v unrar >/dev/null 2>&1; then
            unrar x npc.rar -y
          else
            python3 -c "import rarfile; rf = rarfile.RarFile('npc.rar'); rf.extractall('.')"
          fi
          
          echo "âœ… Extraction complete"
          
          # Find the Build directory
          if [ -d "npc/Build" ]; then
            BUILD_DIR="npc/Build"
          elif [ -d "Build" ]; then
            BUILD_DIR="Build"
          else
            echo "âŒ Build directory not found!"
            find . -type d -name "Build" || echo "No Build directory found"
            exit 1
          fi
          
          echo "ðŸ“ Build directory: $BUILD_DIR"
          ls -lh "$BUILD_DIR" | head -20

      - name: Create or verify GCS bucket
        run: |
          BUCKET_NAME="${{ env.GCS_BUCKET_NAME }}"
          echo "ðŸ“¦ Setting up GCS bucket: $BUCKET_NAME"
          
          # Create bucket if it doesn't exist
          if ! gsutil ls -b "gs://$BUCKET_NAME" >/dev/null 2>&1; then
            echo "Creating new bucket..."
            gsutil mb -p "${{ env.PROJECT_ID }}" -c STANDARD -l "${{ env.REGION }}" "gs://$BUCKET_NAME/"
          else
            echo "âœ… Bucket already exists"
          fi
          
          # Configure CORS for browser access
          echo "ðŸŒ Configuring CORS..."
          cat > /tmp/cors.json << 'EOF'
          [
            {
              "origin": ["*"],
              "method": ["GET", "HEAD", "OPTIONS"],
              "responseHeader": [
                "Content-Type",
                "Content-Encoding",
                "Cache-Control",
                "Cross-Origin-Embedder-Policy",
                "Cross-Origin-Opener-Policy",
                "Cross-Origin-Resource-Policy"
              ],
              "maxAgeSeconds": 3600
            }
          ]
          EOF
          gsutil cors set /tmp/cors.json "gs://$BUCKET_NAME"
          
          # Make bucket publicly readable (required for Unity WebGL browser access)
          echo "ðŸ”“ Making bucket publicly readable..."
          gsutil iam ch allUsers:objectViewer "gs://$BUCKET_NAME" || echo "Permissions may already be set"
          
          echo "âœ… Bucket configured for public access and CORS"
          
          echo "âœ… Bucket setup complete: gs://$BUCKET_NAME"

      - name: Upload Unity files to GCS
        run: |
          BUCKET_NAME="${{ env.GCS_BUCKET_NAME }}"
          cd unity-temp
          
          # Find Build directory
          if [ -d "npc/Build" ]; then
            BUILD_DIR="npc/Build"
          else
            BUILD_DIR="Build"
          fi
          
          echo "ðŸ“¤ Uploading Unity files to GCS..."
          echo "Source: $BUILD_DIR"
          echo "Destination: gs://$BUCKET_NAME/unity/npc/Build/"
          echo ""
          echo "Note: Files are uploaded with .gz extension (for nginx redirect)"
          echo ""
          
          # Upload .wasm.gz files (keep .gz extension for redirect)
          echo "1. Uploading .wasm.gz files..."
          find "$BUILD_DIR" -name "*.wasm.gz" -type f | while read -r file; do
            filename=$(basename "$file")
            echo "   Uploading $filename..."
            gsutil -h "Content-Type:application/wasm" \
                   -h "Content-Encoding:gzip" \
                   cp "$file" "gs://$BUCKET_NAME/unity/npc/Build/$filename"
          done
          
          # Upload .data.gz files (keep .gz extension for redirect)
          echo "2. Uploading .data.gz files..."
          find "$BUILD_DIR" -name "*.data.gz" -type f | while read -r file; do
            filename=$(basename "$file")
            echo "   Uploading $filename..."
            gsutil -h "Content-Type:application/octet-stream" \
                   -h "Content-Encoding:gzip" \
                   cp "$file" "gs://$BUCKET_NAME/unity/npc/Build/$filename"
          done
          
          # Upload .js.gz files (keep .gz extension for redirect)
          echo "3. Uploading .js.gz files..."
          find "$BUILD_DIR" -name "*.js.gz" -type f | while read -r file; do
            filename=$(basename "$file")
            echo "   Uploading $filename..."
            gsutil -h "Content-Type:application/javascript" \
                   -h "Content-Encoding:gzip" \
                   cp "$file" "gs://$BUCKET_NAME/unity/npc/Build/$filename"
          done
          
          # Upload .js files (non-gzipped like loader.js)
          echo "4. Uploading .js files (non-gzipped)..."
          find "$BUILD_DIR" -name "*.js" -type f ! -name "*.gz" | while read -r file; do
            filename=$(basename "$file")
            echo "   Uploading $filename..."
            gsutil -h "Content-Type:application/javascript" \
                   cp "$file" "gs://$BUCKET_NAME/unity/npc/Build/$filename"
          done
          
          # Upload TemplateData directory (usually in parent directory, not Build/)
          echo "5. Uploading TemplateData directory..."
          if [ -d "$(dirname "$BUILD_DIR")/TemplateData" ]; then
            echo "   Found TemplateData in parent directory..."
            gsutil -m cp -r "$(dirname "$BUILD_DIR")/TemplateData" "gs://$BUCKET_NAME/unity/npc/"
          elif [ -d "$BUILD_DIR/TemplateData" ]; then
            echo "   Found TemplateData in Build directory..."
            gsutil -m cp -r "$BUILD_DIR/TemplateData" "gs://$BUCKET_NAME/unity/npc/Build/"
          else
            echo "   âš ï¸ TemplateData directory not found (may cause 404 errors)"
          fi
          
          # Upload index.html if it exists in parent directory
          echo "6. Uploading index.html..."
          if [ -f "$(dirname "$BUILD_DIR")/index.html" ]; then
            echo "   Found index.html in parent directory..."
            gsutil -h "Content-Type:text/html" \
                   cp "$(dirname "$BUILD_DIR")/index.html" "gs://$BUCKET_NAME/unity/npc/index.html"
          elif [ -f "npc/index.html" ]; then
            echo "   Found index.html in npc directory..."
            gsutil -h "Content-Type:text/html" \
                   cp "npc/index.html" "gs://$BUCKET_NAME/unity/npc/index.html"
          else
            echo "   âš ï¸ index.html not found (may cause 404 errors)"
          fi
          
          # Upload logo files (logo1.png, logo2.png, etc.)
          echo "7. Uploading logo and image files..."
          find "$(dirname "$BUILD_DIR")" -maxdepth 1 -type f \( -name "logo*.png" -o -name "logo*.jpg" -o -name "favicon.ico" -o -name "*.css" \) 2>/dev/null | while read -r file; do
            filename=$(basename "$file")
            ext="${filename##*.}"
            case "$ext" in
              png) content_type="image/png" ;;
              jpg|jpeg) content_type="image/jpeg" ;;
              ico) content_type="image/x-icon" ;;
              css) content_type="text/css" ;;
              *) content_type="application/octet-stream" ;;
            esac
            echo "   Uploading $filename ($content_type)..."
            gsutil -h "Content-Type:$content_type" \
                   cp "$file" "gs://$BUCKET_NAME/unity/npc/$filename"
          done || echo "   No logo/image files found"
          
          # Upload all other files from npc directory (style.css, etc.)
          echo "8. Uploading other files from npc directory..."
          if [ -d "npc" ]; then
            find "npc" -maxdepth 1 -type f ! -name "*.rar" ! -name "*.zip" 2>/dev/null | while read -r file; do
              filename=$(basename "$file")
              # Skip if already uploaded
              if [[ "$filename" != "index.html" ]] && [[ ! "$filename" =~ ^logo ]] && [[ "$filename" != "favicon.ico" ]]; then
                ext="${filename##*.}"
                case "$ext" in
                  css) content_type="text/css" ;;
                  json) content_type="application/json" ;;
                  *) content_type="application/octet-stream" ;;
                esac
                echo "   Uploading $filename ($content_type)..."
                gsutil -h "Content-Type:$content_type" \
                       cp "$file" "gs://$BUCKET_NAME/unity/npc/$filename"
              fi
            done || echo "   No additional files found"
          fi
          
          echo ""
          echo "âœ… Upload complete!"
          echo "ðŸ“‹ Verifying uploaded files..."
          echo ""
          echo "ðŸ“ Root directory:"
          gsutil ls -lh "gs://$BUCKET_NAME/unity/npc/" | grep -v "^gs://.*/$" | head -20 || echo "   No files in root"
          echo ""
          echo "ðŸ“ Build directory:"
          gsutil ls -lh "gs://$BUCKET_NAME/unity/npc/Build/" | head -20
          echo ""
          echo "ðŸ“ TemplateData directory:"
          gsutil ls -lh "gs://$BUCKET_NAME/unity/npc/TemplateData/" 2>/dev/null | head -10 || echo "   TemplateData not found"
          
          echo ""
          echo "ðŸ”§ Setting Cache-Control headers for optimal CDN performance..."
          # Set cache headers for immutable files (Unity WebGL files)
          gsutil -m setmeta -h "Cache-Control:public, max-age=31536000, immutable" \
            "gs://$BUCKET_NAME/unity/npc/Build/*.gz" \
            "gs://$BUCKET_NAME/unity/npc/Build/*.js" \
            "gs://$BUCKET_NAME/unity/npc/Build/*.wasm" \
            "gs://$BUCKET_NAME/unity/npc/Build/*.data" \
            "gs://$BUCKET_NAME/unity/npc/TemplateData/**" \
            "gs://$BUCKET_NAME/unity/npc/*.png" \
            "gs://$BUCKET_NAME/unity/npc/*.jpg" \
            "gs://$BUCKET_NAME/unity/npc/*.ico" \
            "gs://$BUCKET_NAME/unity/npc/*.css" 2>/dev/null || echo "   Some files may not exist (this is OK)"
          
          # Set shorter cache for HTML files (may be updated)
          gsutil -m setmeta -h "Cache-Control:public, max-age=3600" \
            "gs://$BUCKET_NAME/unity/npc/*.html" 2>/dev/null || echo "   HTML files may not exist (this is OK)"
          
          echo "âœ… Cache headers set"
          
          echo ""
          echo "ðŸ”— Public URLs (for testing):"
          echo "   https://storage.googleapis.com/$BUCKET_NAME/unity/npc/index.html"
          echo "   https://storage.googleapis.com/$BUCKET_NAME/unity/npc/Build/yes.loader.js"
          echo "   https://storage.googleapis.com/$BUCKET_NAME/unity/npc/Build/yes.data.gz"
          echo "   https://storage.googleapis.com/$BUCKET_NAME/unity/npc/Build/yes.wasm.gz"
          echo "   https://storage.googleapis.com/$BUCKET_NAME/unity/npc/TemplateData/style.css"
          echo ""
          echo "ðŸ’¡ Tip: Enable Cloud CDN for even better performance (see ENABLE_CLOUD_CDN.md)"

      - name: Setup Cloud CDN
        continue-on-error: true
        run: |
          BUCKET_NAME="${{ env.GCS_BUCKET_NAME }}"
          BACKEND_NAME="${BUCKET_NAME}-backend"
          URL_MAP_NAME="${BUCKET_NAME}-map"
          PROXY_NAME="${BUCKET_NAME}-proxy"
          FORWARDING_RULE_NAME="${BUCKET_NAME}-forwarding-rule"
          IP_NAME="${BUCKET_NAME}-ip"
          
          echo "=========================================="
          echo "ðŸŒ Setting up Cloud CDN"
          echo "=========================================="
          echo "Bucket: $BUCKET_NAME"
          echo "Backend: $BACKEND_NAME"
          echo ""
          
          # Check if backend bucket already exists
          if gcloud compute backend-buckets describe "$BACKEND_NAME" --global --project="${{ env.PROJECT_ID }}" >/dev/null 2>&1; then
            echo "âœ… Backend bucket already exists: $BACKEND_NAME"
          else
            echo "ðŸ“¦ Creating backend bucket..."
            gcloud compute backend-buckets create "$BACKEND_NAME" \
              --gcs-bucket-name="$BUCKET_NAME" \
              --project="${{ env.PROJECT_ID }}" \
              --global || echo "âš ï¸  Backend bucket creation failed (may already exist)"
          fi
          
          # Enable Cloud CDN on backend
          echo "ðŸš€ Enabling Cloud CDN on backend..."
          gcloud compute backend-buckets update "$BACKEND_NAME" \
            --enable-cdn \
            --project="${{ env.PROJECT_ID }}" \
            --global || echo "âš ï¸  CDN enable failed (may already be enabled)"
          
          # Check if URL map exists
          if gcloud compute url-maps describe "$URL_MAP_NAME" --global --project="${{ env.PROJECT_ID }}" >/dev/null 2>&1; then
            echo "âœ… URL map already exists: $URL_MAP_NAME"
          else
            echo "ðŸ—ºï¸  Creating URL map..."
            gcloud compute url-maps create "$URL_MAP_NAME" \
              --default-backend-bucket="$BACKEND_NAME" \
              --project="${{ env.PROJECT_ID }}" \
              --global || echo "âš ï¸  URL map creation failed"
          fi
          
          # Check if proxy exists
          if gcloud compute target-http-proxies describe "$PROXY_NAME" --global --project="${{ env.PROJECT_ID }}" >/dev/null 2>&1; then
            echo "âœ… HTTP proxy already exists: $PROXY_NAME"
          else
            echo "ðŸ”— Creating HTTP proxy..."
            gcloud compute target-http-proxies create "$PROXY_NAME" \
              --url-map="$URL_MAP_NAME" \
              --project="${{ env.PROJECT_ID }}" \
              --global || echo "âš ï¸  Proxy creation failed"
          fi
          
          # Check if static IP exists
          if gcloud compute addresses describe "$IP_NAME" --global --project="${{ env.PROJECT_ID }}" >/dev/null 2>&1; then
            echo "âœ… Static IP already exists: $IP_NAME"
            IP_ADDRESS=$(gcloud compute addresses describe "$IP_NAME" \
              --global \
              --format="value(address)" \
              --project="${{ env.PROJECT_ID }}")
          else
            echo "ðŸŒ Reserving static IP..."
            gcloud compute addresses create "$IP_NAME" \
              --global \
              --project="${{ env.PROJECT_ID }}" || echo "âš ï¸  IP reservation failed"
            
            # Get IP address
            IP_ADDRESS=$(gcloud compute addresses describe "$IP_NAME" \
              --global \
              --format="value(address)" \
              --project="${{ env.PROJECT_ID }}" 2>/dev/null || echo "")
          fi
          
          if [ -n "$IP_ADDRESS" ]; then
            echo "âœ… Static IP: $IP_ADDRESS"
            
            # Check if forwarding rule exists
            if gcloud compute forwarding-rules describe "$FORWARDING_RULE_NAME" --global --project="${{ env.PROJECT_ID }}" >/dev/null 2>&1; then
              echo "âœ… Forwarding rule already exists: $FORWARDING_RULE_NAME"
            else
              echo "ðŸ“¡ Creating forwarding rule..."
              gcloud compute forwarding-rules create "$FORWARDING_RULE_NAME" \
                --global \
                --target-http-proxy="$PROXY_NAME" \
                --address="$IP_ADDRESS" \
                --ports=80 \
                --project="${{ env.PROJECT_ID }}" || echo "âš ï¸  Forwarding rule creation failed"
            fi
            
            echo ""
            echo "=========================================="
            echo "âœ… Cloud CDN setup complete!"
            echo "=========================================="
            echo "ðŸŒ CDN URL: http://$IP_ADDRESS/unity/npc/"
            echo "ðŸŒ CDN HTTPS URL: https://$IP_ADDRESS/unity/npc/ (if HTTPS proxy configured)"
            echo ""
            echo "ðŸ“ CDN IP Address saved for future reference: $IP_ADDRESS"
            echo ""
            echo "ðŸ’¡ Note: nginx.conf uses proxy_pass to GCS directly (faster than redirect)"
            echo "   To use CDN URL instead, update nginx.conf:"
            echo "   proxy_pass http://$IP_ADDRESS/unity/npc/;"
            echo ""
            echo "ðŸ’¡ For HTTPS, set up SSL certificate and use HTTPS proxy"
          else
            echo "âš ï¸  Could not get static IP address"
            echo "   Using direct GCS proxy (still fast, but CDN would be faster)"
          fi
          
          # Output CDN IP for potential use in nginx config
          if [ -n "$IP_ADDRESS" ]; then
            echo "CDN_IP=$IP_ADDRESS" >> $GITHUB_ENV
          fi

      - name: Output GCS bucket name and CDN IP
        id: gcs-bucket
        run: |
          echo "bucket=${{ env.GCS_BUCKET_NAME }}" >> $GITHUB_OUTPUT
          echo "âœ… GCS bucket ready: ${{ env.GCS_BUCKET_NAME }}"
          
          # Get CDN IP if available (from previous step)
          if [ -n "${{ env.CDN_IP }}" ]; then
            echo "cdn_ip=${{ env.CDN_IP }}" >> $GITHUB_OUTPUT
            echo "âœ… CDN IP available: ${{ env.CDN_IP }}"
          else
            echo "cdn_ip=" >> $GITHUB_OUTPUT
            echo "âš ï¸  CDN IP not available (will use GCS directly)"
          fi

  deploy:
    name: Build and Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: setup-gcs-and-upload
    outputs:
      cdn_ip: ${{ needs.setup-gcs-and-upload.outputs.cdn_ip }}
    
    permissions:
      contents: read
      id-token: write
      pull-requests: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify GCP Secret
        run: |
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "âŒ Error: GCP_SA_KEY secret is not set!"
            echo "Please add it in: Settings > Secrets and variables > Actions"
            exit 1
          else
            echo "âœ… GCP_SA_KEY secret is set"
          fi

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          export_default_credentials: true

      - name: Configure Docker
        run: gcloud auth configure-docker

      - name: Enable required APIs
        continue-on-error: true
        run: |
          gcloud services enable cloudresourcemanager.googleapis.com --quiet
          gcloud services enable cloudbuild.googleapis.com --quiet
          gcloud services enable run.googleapis.com --quiet
          gcloud services enable containerregistry.googleapis.com --quiet

      - name: Grant Cloud Build Service Account permissions
        continue-on-error: true
        run: |
          PROJECT_NUMBER=$(gcloud projects describe ${{ env.PROJECT_ID }} --format='value(projectNumber)')
          gcloud projects add-iam-policy-binding ${{ env.PROJECT_ID }} \
            --member="serviceAccount:${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com" \
            --role="roles/run.admin" \
            --condition=None || echo "Permissions may already be set"
          gcloud projects add-iam-policy-binding ${{ env.PROJECT_ID }} \
            --member="serviceAccount:${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com" \
            --role="roles/iam.serviceAccountUser" \
            --condition=None || echo "Permissions may already be set"

      - name: Submit to Cloud Build with GCS bucket and CDN IP
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          GCS_BUCKET="${{ env.GCS_BUCKET_NAME }}"
          CDN_IP="${{ needs.setup-gcs-and-upload.outputs.cdn_ip }}"
          
          echo "ðŸš€ Deploying with GCS bucket: $GCS_BUCKET"
          if [ -n "$CDN_IP" ]; then
            echo "ðŸŒ Using CDN IP: $CDN_IP"
            gcloud builds submit --config cloudbuild.yaml \
              --substitutions=_COMMIT_SHA=${{ github.sha }},_SHORT_SHA=${SHORT_SHA},_UNITY_GCS_BUCKET=${GCS_BUCKET},_CDN_IP=${CDN_IP}
          else
            echo "ðŸ“¦ Using GCS directly (CDN not available)"
            gcloud builds submit --config cloudbuild.yaml \
              --substitutions=_COMMIT_SHA=${{ github.sha }},_SHORT_SHA=${SHORT_SHA},_UNITY_GCS_BUCKET=${GCS_BUCKET}
          fi

      - name: Get Service URL
        id: service-url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Output Service URL
        run: |
          echo "ðŸš€ Deployment successful!"
          echo "Service URL: ${{ steps.service-url.outputs.url }}"
          echo ""
          echo "Your application is now live at:"
          echo "${{ steps.service-url.outputs.url }}"

