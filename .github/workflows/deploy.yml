name: Deploy to Google Cloud Run (Detailed Logging)

# NOTE: This workflow is a backup/alternative to deploy-gcp.yml
# Only one should run at a time. To use this instead, disable deploy-gcp.yml
# or delete it. This workflow has better progress logging but same functionality.

on:
  # Disabled by default - only runs on manual trigger
  # Uncomment the push section below if you want to use this instead of deploy-gcp.yml
  # push:
  #   branches:
  #     - main
  workflow_dispatch: # Allows manual triggering

env:
  PROJECT_ID: meta-478212
  SERVICE_NAME: metavr-frontend
  REGION: us-central1

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: âš™ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: ðŸ“Š Analyze files for upload
        run: |
          echo "=========================================="
          echo "ðŸ“Š Preparing Source Files"
          echo "=========================================="
          echo "â° $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "ðŸ” Analyzing files to be uploaded..."
          
          # Count files (excluding .git and node_modules)
          FILE_COUNT=$(find . -type f \
            -not -path './.git/*' \
            -not -path '*/node_modules/*' \
            -not -path '*/dist/*' \
            -not -path '*/build/*' \
            -not -path '*/.next/*' \
            2>/dev/null | wc -l | tr -d ' ')
          
          # Calculate total size
          TOTAL_SIZE=$(find . -type f \
            -not -path './.git/*' \
            -not -path '*/node_modules/*' \
            -not -path '*/dist/*' \
            -not -path '*/build/*' \
            -not -path '*/.next/*' \
            2>/dev/null -exec du -ch {} + | tail -1 | cut -f1)
          
          echo "ðŸ“ Files to archive: ${FILE_COUNT}"
          echo "ðŸ’¾ Estimated size: ${TOTAL_SIZE}"
          echo ""
          echo "â„¹ï¸  Note: Actual archive may be smaller due to compression"
          echo ""

      - name: ðŸš€ Submit build to Cloud Build
        run: |
          echo "=========================================="
          echo "ðŸš€ Starting Deployment Process"
          echo "=========================================="
          echo "ðŸ“‹ Project: ${{ env.PROJECT_ID }}"
          echo "ðŸ“¦ Service: ${{ env.SERVICE_NAME }}"
          echo "ðŸŒ Region: ${{ env.REGION }}"
          echo "ðŸ”– Commit: ${{ github.sha }}"
          echo "=========================================="
          echo ""
          
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "ðŸ“Œ Using image tag: ${SHORT_SHA}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“¦ Phase 1: Creating Archive & Uploading"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â° $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "ðŸ“ Creating temporary archive..."
          echo "â³ This may take a moment depending on file count..."
          echo "ðŸ“¤ Uploading to Google Cloud Storage..."
          echo "   (Progress will be shown below)"
          echo ""
          
          # Submit build and capture output with progress tracking
          gcloud builds submit --config cloudbuild.yaml \
            --substitutions=_COMMIT_SHA=${{ github.sha }},_SHORT_SHA=${SHORT_SHA} 2>&1 | \
          while IFS= read -r line || [ -n "$line" ]; do
            # Highlight archive creation with file count and size
            if echo "$line" | grep -q "Creating temporary archive"; then
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ðŸ“¦ ARCHIVE CREATION"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              # Extract and highlight file count and size
              if echo "$line" | grep -qE "[0-9]+ file\(s\)"; then
                FILE_INFO=$(echo "$line" | grep -oE "[0-9]+ file\(s\) totalling [0-9.]+ [KMGT]?i?B")
                echo "ðŸ“¦ $FILE_INFO"
                echo "â³ Compressing files..."
              else
                echo "ðŸ“¦ $line"
              fi
            # Highlight upload progress with GCS path
            elif echo "$line" | grep -q "Uploading tarball"; then
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ðŸ“¤ UPLOADING TO CLOUD STORAGE"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              # Extract GCS path
              GCS_PATH=$(echo "$line" | grep -oE "gs://[^]]+")
              if [ -n "$GCS_PATH" ]; then
                echo "ðŸ“¤ Destination: $GCS_PATH"
              else
                echo "ðŸ“¤ $line"
              fi
              echo "â³ Upload in progress... (this may take a while for large archives)"
            # Show build phase transition
            elif echo "$line" | grep -qE "^â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$"; then
              echo "$line"
            # Show build steps with better formatting
            elif echo "$line" | grep -qE "^(Step|Pulling|Pushing|Building|Running)"; then
              echo ""
              echo "ðŸ”¨ $line"
            # Show status updates
            elif echo "$line" | grep -qE "(SUCCESS|FAILURE|ERROR)"; then
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              if echo "$line" | grep -q "SUCCESS"; then
                echo "âœ… $line"
              elif echo "$line" | grep -q "FAILURE\|ERROR"; then
                echo "âŒ $line"
              else
                echo "$line"
              fi
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            # Show build ID
            elif echo "$line" | grep -qi "ID:"; then
              echo ""
              echo "ðŸ†” $line"
            # Pass through other lines
            else
              echo "$line"
            fi
          done | tee /tmp/build-output.log
          
          # Extract build ID from output (if available)
          BUILD_ID=$(grep -i "ID:" /tmp/build-output.log | tail -1 | awk '{print $NF}' || echo "")
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… Build completed!"
          if [ -n "$BUILD_ID" ]; then
            echo "ðŸ”— Build ID: ${BUILD_ID}"
            echo "ðŸ“Š View details: https://console.cloud.google.com/cloud-build/builds/${BUILD_ID}?project=${{ env.PROJECT_ID }}"
          fi
          
          echo ""
          echo "=========================================="
          echo "âœ… Deployment process completed!"
          echo "=========================================="
          
      - name: Get Service URL
        id: service-url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "ðŸš€ Service deployed at: $URL"

      - name: Output Service URL
        run: |
          echo "ðŸš€ Deployment successful!"
          echo "Service URL: ${{ steps.service-url.outputs.url }}"
          echo ""
          echo "Your application is now live at:"
          echo "${{ steps.service-url.outputs.url }}"

