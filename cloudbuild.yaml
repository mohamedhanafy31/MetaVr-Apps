substitutions:
  _SHORT_SHA: ''
  _COMMIT_SHA: ''

steps:
  # Determine SHORT_SHA: use provided SHORT_SHA, or extract from COMMIT_SHA, or use BUILD_ID
  - name: 'bash'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=========================================="
        echo "üìã Step 1/5: Preparing Build Configuration"
        echo "=========================================="
        echo "‚è∞ $(date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        
        if [ -n "$$_SHORT_SHA" ]; then
          TAG=$$_SHORT_SHA
          echo "‚úÖ Using provided SHORT_SHA: $$TAG"
        elif [ -n "$$_COMMIT_SHA" ]; then
          TAG=$${_COMMIT_SHA:0:7}
          echo "‚úÖ Extracted tag from COMMIT_SHA: $$TAG"
        else
          TAG=$${BUILD_ID:0:7}
          echo "‚úÖ Using BUILD_ID as fallback: $$TAG"
        fi
        
        echo "üìå Final image tag: $$TAG"
        echo "$$TAG" > /workspace/image-tag.txt
        echo "‚úÖ Configuration saved"
        echo ""
    env:
      - '_SHORT_SHA=${_SHORT_SHA}'
      - '_COMMIT_SHA=${_COMMIT_SHA}'
      - 'BUILD_ID=${BUILD_ID}'

  # Build the container image
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=========================================="
        echo "üî® Step 2/5: Building Docker Image"
        echo "=========================================="
        echo "‚è∞ $(date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        
        TAG=$$(cat /workspace/image-tag.txt)
        IMAGE_TAG=gcr.io/$$PROJECT_ID/metavr-frontend:$$TAG
        IMAGE_LATEST=gcr.io/$$PROJECT_ID/metavr-frontend:latest
        
        echo "üì¶ Building image: $$IMAGE_TAG"
        echo "üì¶ Also tagging as: $$IMAGE_LATEST"
        echo "‚è≥ This may take a few minutes..."
        echo ""
        
        docker build \
          -t $$IMAGE_TAG \
          -t $$IMAGE_LATEST \
          -f vite-project/Dockerfile.prod \
          vite-project
        
        echo ""
        echo "‚úÖ Docker image built successfully!"
        echo "üì¶ Image: $$IMAGE_TAG"
        echo ""
    env:
      - 'PROJECT_ID=${PROJECT_ID}'

  # Push the container image to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=========================================="
        echo "üì§ Step 3/5: Pushing Docker Image (Tagged)"
        echo "=========================================="
        echo "‚è∞ $(date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        
        TAG=$$(cat /workspace/image-tag.txt)
        IMAGE_TAG=gcr.io/$$PROJECT_ID/metavr-frontend:$$TAG
        
        echo "üì§ Pushing: $$IMAGE_TAG"
        echo "‚è≥ Uploading to Container Registry..."
        echo ""
        
        docker push $$IMAGE_TAG
        
        echo ""
        echo "‚úÖ Image pushed successfully!"
        echo ""
    env:
      - 'PROJECT_ID=${PROJECT_ID}'

  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=========================================="
        echo "üì§ Step 4/5: Pushing Docker Image (Latest)"
        echo "=========================================="
        echo "‚è∞ $(date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        
        IMAGE_LATEST=gcr.io/$$PROJECT_ID/metavr-frontend:latest
        
        echo "üì§ Pushing: $$IMAGE_LATEST"
        echo "‚è≥ Uploading to Container Registry..."
        echo ""
        
        docker push $$IMAGE_LATEST
        
        echo ""
        echo "‚úÖ Latest image pushed successfully!"
        echo ""
    env:
      - 'PROJECT_ID=${PROJECT_ID}'

  # Deploy container image to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=========================================="
        echo "üöÄ Step 5/5: Deploying to Cloud Run"
        echo "=========================================="
        echo "‚è∞ $(date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        
        TAG=$$(cat /workspace/image-tag.txt)
        IMAGE_TAG=gcr.io/$$PROJECT_ID/metavr-frontend:$$TAG
        
        echo "üåç Service: metavr-frontend"
        echo "üìç Region: us-central1"
        echo "üì¶ Image: $$IMAGE_TAG"
        echo "üíæ Memory: 512Mi"
        echo "‚ö° CPU: 1"
        echo "‚è≥ Deploying..."
        echo ""
        
        gcloud run deploy metavr-frontend \
          --image $$IMAGE_TAG \
          --region us-central1 \
          --platform managed \
          --allow-unauthenticated \
          --port 80 \
          --memory 512Mi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 10 \
          --timeout 300 \
          --format="value(status.url)"
        
        echo ""
        echo "=========================================="
        echo "‚úÖ Deployment completed successfully!"
        echo "=========================================="
        echo "‚è∞ $(date '+%Y-%m-%d %H:%M:%S')"
        echo ""
    env:
      - 'PROJECT_ID=${PROJECT_ID}'

images:
  - 'gcr.io/$PROJECT_ID/metavr-frontend:latest'

options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

timeout: '1200s'

